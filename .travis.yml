language: shell
os: linux
dist: focal

git:
  depth: false # tags for `git describe` may be farther away than the default depth

jobs:
  include:
    - stage: test
      osx_image: xcode12.2
      os: osx
    - osx_image: xcode12u
      os: osx
    - osx_image: xcode12
      os: osx
    - osx_image: xcode11.6
      os: osx
    - osx_image: xcode11.5
      os: osx
    - osx_image: xcode11.4
      os: osx
    - osx_image: xcode11.3
      os: osx
    - osx_image: xcode10.1
      os: osx
    - osx_image: xcode9.2
      os: osx
    - osx_image: xcode8
      os: osx
    - stage: test2
      os: windows
    - stage: test3
      dist: focal
    - dist: bionic
    - dist: xenial
    - dist: trusty
    - dist: precise
  exclude:
    - if: branch != master
      env: TRAVIS_TAG=nightly
  allow_failures:
    - dist: precise
    - osx_image: xcode10.1
      os: osx
    - osx_image: xcode9.2
      os: osx
    - osx_image: xcode8
      os: osx

script:
  - if [[ "${TRAVIS_OS_NAME}" == "linux" ]]; then wget -q https://github.com/knossos-project/knossos/releases/download/nightly/linux.KNOSSOS.nightly.AppImage && chmod +x linux.KNOSSOS.nightly.AppImage && ./linux.KNOSSOS.nightly.AppImage test; fi
  - if [[ "${TRAVIS_OS_NAME}" == "osx"   ]]; then wget -q https://github.com/knossos-project/knossos/releases/download/nightly-dev/macos.py3-KNOSSOS.nightly.app.zip && unzip -q macos.py3-KNOSSOS.nightly.app.zip && ./KNOSSOS.app/Contents/MacOS/knossos test; fi
  - if [[ "${TRAVIS_OS_NAME}" == "windows"   ]]; then wget -q https://github.com/knossos-project/knossos/releases/download/nightly-dev/win.py3-KNOSSOS.nightly.exe && ./win.py3-KNOSSOS.nightly.exe test; fi

deploy:
  - provider: releases
    edge: true
    token:
      secure: "DHBayH59cTgSeuzw0umwjc52r5p1sR3EV1vOG77cK1NIb7fi2UVmx69V2mIzfGYp0t1uFDsVvDGtFYRQxKozCteBu2oinmbiSjbeWnyldQqTFnF4QONF+eWGiHNdOdHY7Tj37+eV5BlgfsXZ5MfLN3tXZ2y++D+yfoUItsbvC3I="
    file_glob: true
    file:
      - "linux.KNOSSOS.nightly.AppImage"
      - "macos.KNOSSOS.nightly.app.zip"
    overwrite: true
    on:
      repo: knossos-project/knossos
      branch: master
      condition: $TRAVIS_TAG = nightly
  - provider: releases
    edge: true
    token:
      secure: "DHBayH59cTgSeuzw0umwjc52r5p1sR3EV1vOG77cK1NIb7fi2UVmx69V2mIzfGYp0t1uFDsVvDGtFYRQxKozCteBu2oinmbiSjbeWnyldQqTFnF4QONF+eWGiHNdOdHY7Tj37+eV5BlgfsXZ5MfLN3tXZ2y++D+yfoUItsbvC3I="
    file_glob: true
    file:
      - "linux.*-KNOSSOS.nightly.AppImage"
      - "macos.*-KNOSSOS.nightly.app.zip"
    overwrite: true
    on:
      repo: knossos-project/knossos
      all_branches: true
      condition: $TRAVIS_TAG = nightly-dev
