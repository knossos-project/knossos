version: '{build} {branch}'

image:
  - macOS-sonoma   # 14.2.1
  - macOS-ventura  # 13.6.4

environment:
  MESA_DIST_WIN_VER: 22.0.3
  # QT_OPENGL: angle # desktop angle software
  QT_OPENGL_DLL: opengl32

init:
  - appveyor version
  - cmd: ver
  - cmd: systeminfo | findstr /B /C:"OS Name" /C:"OS Version"
  - sh: type system_profiler && system_profiler SPSoftwareDataType SPHardwareDataType || true
  - sh: type lsb_release && lsb_release -a || true
  - sh: type uname && uname -a || true

for:
-
  matrix:
    only:
      - image: macOS-sonoma
  install:
    - brew pin appveyor-build-agent # https://github.com/appveyor/ci/issues/3763#issuecomment-1003168277
    - time brew upgrade || true # skipped upgrades for pinned packages donâ€™t return cleanly
    - time brew remove qt6 || true
    - time brew install boost ninja python qt5 snappy
    - time python3 -m pip install requests --break-system-packages
    - time python3 -m pip install numpy --break-system-packages
    - time python3 -c 'import numpy,requests; print(requests.__path__, numpy.__path__)'                                                                                                                                          
    - time brew install --overwrite cmake # for building from source, brew needs its own cmake, which conflicts with the preinstalled one
    - time brew tap --force homebrew/core
    - sed -e 's/"qtbase"/"qt@5"/' -i bak $(brew edit --print-path quazip)
    # Warning: `brew install` ignores locally edited casks and formulae if HOMEBREW_NO_INSTALL_FROM_API is not set.
    - time env HOMEBREW_NO_INSTALL_FROM_API=1 brew install -s quazip # build from source (with patched qt5 dependency)
    - sh ci/build_macos_PythonQt.sh
  build_script:
    - sh ci/build_macos.sh
  test_script:
    - ../knossos-build/KNOSSOS.app/Contents/MacOS/knossos exit
  artifacts:
    - path: '*nightly.*'
-
  matrix:
    only:
      - image: macOS-ventura
  before_test:
    - curl --fail -JLO https://github.com/knossos-project/knossos/releases/download/nightly-dev/macos.$APPVEYOR_REPO_BRANCH-KNOSSOS.nightly.app.zip
    - unzip -q macos.$APPVEYOR_REPO_BRANCH-KNOSSOS.nightly.app.zip
  build: off
  test_script:
    - KNOSSOS.app/Contents/MacOS/knossos exit
  deploy: off

test_script:
  - cmd: curl --fail -JLO https://github.com/pal1000/mesa-dist-win/releases/download/%MESA_DIST_WIN_VER%/mesa3d-%MESA_DIST_WIN_VER%-release-msvc.7z
  - cmd: 7z e "-i!x64/*.dll" "-i!x64/*.json" "mesa3d-*-release-msvc.7z"
  - cmd: cp -v C:/Python3*-x64/python3*.dll . || true
  - cmd: win.%APPVEYOR_REPO_BRANCH%-KNOSSOS.nightly.exe exit
  # custom screen specification is required for 1604, because the default used to be only 8 bit
  - sh: time xvfb-run -e /dev/stdout --auto-servernum -s '-screen 0 1024x768x24' ./linux.$APPVEYOR_REPO_BRANCH-KNOSSOS.nightly.AppImage exit

deploy:
  - provider: GitHub
    tag: nightly
    auth_token:
      secure: t9BAyR+k93XD/dXN/gaOgApdGKOxb4lvDtpci8pHHxghvSxd/wNGdFFe/N9WqZSr
    artifact: /.*\.KNOSSOS\..*/
    prerelease: true
    force_update: true
    on:
      branch: master
  - provider: GitHub
    tag: nightly-dev
    auth_token:
      secure: t9BAyR+k93XD/dXN/gaOgApdGKOxb4lvDtpci8pHHxghvSxd/wNGdFFe/N9WqZSr
    artifact: /.*-KNOSSOS\..*/
    prerelease: true
    force_update: true
